# Peer-to-Peer Chat Node (p2p.py)

Простая реализация однорангового (P2P) узла на Python с использованием TCP-сокетов и потоков.

## Описание

- Узел одновременно выступает сервером и клиентом: слушает входящие соединения и инициирует исходящие к известным пирами.
- Обменивается списками известных пиров для расширения сети.
- Передает текстовые сообщения с идентификацией отправителя.
- Исключает повторную передачу уже полученных сообщений.
- Использует многопоточность для параллельной работы с несколькими соединениями.
- Встроенный CLI для ввода и отправки сообщений.

## Запуск

`python p2p.py <port> [peer_host:peer_port ...]`

- `<port>` — локальный порт для прослушивания.
- `[peer_host:peer_port ...]` — список пиров для автоматического подключения при старте.

⚠️ Для локальных тестов указывайте `127.0.0.1` вместо `0.0.0.0` в коде для корректной работы на localhost.

---

## Примеры использования

### 1. Один хост, 3 узла (3 порта)

Откройте 3 терминала на одном хосте и запустите:

Терминал 1

`python p2p.py 8001 127.0.0.1:8002 127.0.0.1:8003`
Терминал 2

`python p2p.py 8002 127.0.0.1:8001 127.0.0.1:8003`
Терминал 3

`python p2p.py 8003 127.0.0.1:8001 127.0.0.1:8002`

В результате все узлы образуют сеть и могут обмениваться сообщениями.

---

### 2. Два разных хоста, по одному узлу на каждом (2 узла)

Предполагаемые IP хостов:

- Хост 1: 192.168.1.100
- Хост 2: 192.168.1.101

На каждом хосте запускаем:

Хост 1

`python p2p.py 8001 192.168.1.101:8001`
Хост 2

`python p2p.py 8001 192.168.1.100:8001`

---

### 3. Два хоста, по 3 узла на каждом (всего 6 узлов)

На каждом хосте запускаем 3 экземпляра с разными портами, например:

Хост 1

`python p2p.py 8001 192.168.1.101:8001 192.168.1.101:8002 192.168.1.101:8003`
`python p2p.py 8002 192.168.1.101:8001 192.168.1.101:8002 192.168.1.101:8003`
`python p2p.py 8003 192.168.1.101:8001 192.168.1.101:8002 192.168.1.101:8003`
Хост 2

`python p2p.py 8001 192.168.1.100:8001 192.168.1.100:8002 192.168.1.100:8003`
`python p2p.py 8002 192.168.1.100:8001 192.168.1.100:8002 192.168.1.100:8003`
`python p2p.py 8003 192.168.1.100:8001 192.168.1.100:8002 192.168.1.100:8003`

---

## Использование

- Введите сообщение в консоли и нажмите Enter — оно будет отправлено в сеть.
- Сообщения снабжаются идентификатором отправителя и уникальным ID.
- Полученные сообщения автоматически распространяются среди всех подключенных пиров.
- Для выхода нажмите Ctrl+C.

---

## Возможные проблемы и нюансы

- **Используйте `127.0.0.1` для локальных тестов!** Использование `0.0.0.0` для хоста вызовет ошибки, так как это значит "все интерфейсы", а при "саморекламе" узла это может не работать.
- **Порты должны быть свободны и не заблокированы фаерволом.** Проверьте настройки фаервола/антивируса, чтобы разрешить входящий и исходящий TCP трафик на указанные порты.
- **Сети с NAT и маршрутизаторы.** P2P-соединения могут не устанавливаться, если узлы находятся за NAT без проброса портов. Для подключения между разными хостами обеспечьте открытую маршрутизацию, проброс портов или настройте VPN.
- **Дублирование подключений.** Если запустить несколько узлов с одними и теми же параметрами, возможны конфликтные подключения. Убедитесь, что уникальный `<host>:<port>` задается для каждого узла.
- **Потеря сообщений.** В случае резкого разрыва соединения сообщения могут недоставляться. Код не реализует повторные попытки доставки.
- **Потоки и ресурсы.** Многопоточность требует аккуратного управления ресурсами — при высоком количестве узлов могут возникать проблемы с производительностью.
- **Обработка ошибок.** В коде есть базовая обработка сетевых исключений, но в сложных сетевых условиях возможны неожиданные сбои.
- **Общедоступные IP.** Для работы по публичным IP убедитесь, что серверы доступны извне, и порты открыты у провайдера.
- **Сетевая задержка и пакетная потеря** влияют на качество работы и скорость появления сообщений у всех узлов.
- **Безопасность.** Протокол полностью открытый без шифрования или аутентификации — в реальных системах нужна защита.

---

## Рекомендации по отладке

- Используйте `netstat`/`ss` для проверки занятости портов.
- Проверяйте логи запуска — они показывают подключения и сообщения.
- Для диагностики сетевых проблем пользуйтесь инструментами `ping`, `traceroute` и `telnet` для проверки доступности портов.
- Убедитесь, что фаерволы и роутеры не блокируют трафик.
- При работе на разных хостах убедитесь, что сети видят друг друга (например, имеют общий VPN или находятся в одной подсети).

---

Это учебный пример для знакомства с P2P на Python, TCP и потоках. Для продакшн-систем требуется доработка по безопасности, устойчивости, NAT traversal и др.

Если нужны советы по таким доработкам — обращайтесь!
